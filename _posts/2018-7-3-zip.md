---
layout: post
title: zx7 etc...
---

Когда писал код движка, рассчитывал на то что игра будет только в snap-версиях, все же 2018 год, 21й век, эмуляторы спектрума сейчас где угодно есть... Поэтому если в игре настала смерть главного героя или он попал в безвыходное положение ( о чем игра любезно умолчит ), подразумевалось что игрок заново
тыкает в файл "cell3326.sna" и эмулятор за секунду загружает новую игру.

Никогда бы не подумал что игру захотят запустить на реале, но внезапно поступил запрос на **tap**-версию.

Ок. Первая версия tap формируемая исключительно sjasmplus почему-то не захотела корректно загружаться в эмуляторах без включенной опции ускоренной загрузки, пришлось задействовать утилиту bin2tap.

Тут всплыло 2 нюанса: 

- грузить игру через tap без сжатия несколько медленно и не круто
- после смерти главного героя для повторного прохождения игры приходится снова загружать tap

Пришлось разделить игру на 3 части:
- собственно скриптовый движок
- статические данные ( скрипты, описание предметов)
- изменяемые данные (карта уровня, начальные параметры предметов и героев)

Таким образом после первоначальной загрузки всех частей при последующем рестарте придется загрузить только изменяемые данные.

<i>На данный момент игра не предусматривает загрузки уровней с различными предметами, поэтому движок и
статические данные объединил в одну секцию...</i>

Посмотрел как сжимает 7zx  - сжимает отлично, повезло что в память 48к умещалась вся игра как в запакованном так и в распакованном виде ( карта 32x32 в демо-версии заполнена в основном нулями, массив описания предметов тоже ), это значит не нужно переходить на 128к или перемещать данные с места на место после распаковки.

В итоге код в памяти выглядит так:

<b>
[ движок+статические данные ]<br>
[ динамические данные ]<br>
[ сжатые динамические данные ]<br>
[ сжатые статические данные ]<br>
[ распаковщик ]</b>

<i>Две последние секции понадобятся только один раз - при первоначальном запуске распаковщика, который распакует статические данные и передаст управление на движок...</i>

Перешел с Atom на VisualStudio Code. VSC позволяет организовать сборку через запуск зависимых тасков в файле <b>tasks.json</b>  - клевый тулчейн для сборки, все почти по-взрослому :)
- <b>"parts.asm":</b> sjasmplus компилит игру и сохраняет в виде файлов статическую (<b>static.bin</b>) 
  и динамическую (<b>dynamic.bin</b>) части
- <b>"zx7":</b> архиватор zx7 сжимает бинарные файлы в static.bin.zx7, dynamic.bin.zx7
- <b>"one.asm":</b> sjasmplus сохраняет на диск сжатые данные + распаковщик в виде файла game.bin, выводя в консоль сборки
  данные об адресе начала файла в памяти(<b>BINARY BEGIN</b>), его длине (<b>BINARY SIZE</b>) и адресе запуска распаковщика (<b>BINARY START</b>)
- к сожалению ручная правка параметров из предыдущей задачи в строке запуска задачи **make_tape**
  (пока не научился автоматически передавать параметры из одной задачи в другую, на bash-скрипты завязываться не хочу)
- <b>"make_tape:"</b> запуск утилиты <b>bin2tap</b> для сборки tap-файла.

Добавил в начало движка инициализацию игры ( обнуление переменных, распаковка динамических данных ) и сделал
в скрипте game_over переход на начало после нажатия any key. Как-то так...